{% extends "base.html" %}
{% block title %}Chat General{% endblock %}
{% block content %}
<h2>Chat General</h2>
<div id="chat-log" style="height:300px;overflow:auto;border:1px solid #ccc;"></div>
<input id="chat-message-input" type="text" size="80">
<button id="chat-message-submit" class="btn btn-primary">Enviar</button>
<script>
  const scheme = window.location.protocol === "https:" ? "wss" : "ws";
  const host   = window.location.host; 
  const chatSocket = new WebSocket(`${scheme}://${host}/ws/chat/general/`);

  const chatLog = document.getElementById('chat-log');
  const input   = document.getElementById('chat-message-input');
  const btn     = document.getElementById('chat-message-submit');

  chatSocket.onopen = () => console.log("WS abierto");
  chatSocket.onclose = (e) => console.warn("WS cerrado", e);
  chatSocket.onerror = (e) => console.error("WS error", e);

  chatSocket.onmessage = (e) => {
    const data = JSON.parse(e.data);
    // adapta a tu payload actual
    const nombre = data.usuario_nombre ?? data.emisor_nombre ?? "Usuario";
    const p = document.createElement('p');
    p.innerHTML = `<b>${nombre}:</b> ${data.mensaje}`;
    chatLog.appendChild(p);
    chatLog.scrollTop = chatLog.scrollHeight;
  };

  btn.onclick = (e) => {
    e.preventDefault();
    const mensaje = input.value.trim();
    if (!mensaje) return;
    if (chatSocket.readyState !== WebSocket.OPEN) {
      console.warn("WS no est√° OPEN, estado:", chatSocket.readyState);
      return;
    }
    chatSocket.send(JSON.stringify({ mensaje }));
    input.value = "";
  };
</script>

{% endblock %}