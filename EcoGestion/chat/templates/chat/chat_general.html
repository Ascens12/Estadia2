{% extends "base.html" %}
{% block title %}Chat General{% endblock %}
{% block content %}
<h2>Chat General</h2>
<div id="chat-log" style="height:300px;overflow:auto;border:1px solid #ccc;"></div>
<input id="chat-message-input" type="text" size="80">
<button id="chat-message-submit" class="btn btn-primary">Enviar</button>
<script>
  const scheme = location.protocol === "https:" ? "wss" : "ws";
  const host   = location.host;
  const chatSocket = new WebSocket(`${scheme}://${host}/ws/chat/general/`);

  const log   = document.getElementById('chat-log');           // <div id="chat-log"> ... </div>
  const input = document.getElementById('chat-message-input');
  const btn   = document.getElementById('chat-message-submit');

  function addLine({usuario_nombre, mensaje, timestamp}) {
    const p = document.createElement('p');
    const hora = new Date(timestamp).toLocaleTimeString();
    p.innerHTML = `<b>${usuario_nombre}</b> <small>${hora}</small>: ${mensaje}`;
    log.appendChild(p);
    log.scrollTop = log.scrollHeight;
  }

  chatSocket.onmessage = (e) => {
    const data = JSON.parse(e.data);

    if (data.type === "history") {
      // pintar historial inicial
      log.innerHTML = "";                // limpia
      data.messages.forEach(addLine);    // ya viene ordenado ascendente
      return;
    }

    if (data.type === "message") {
      addLine(data);
      return;
    }
  };

  btn.onclick = (ev) => {
    ev.preventDefault();
    const mensaje = input.value.trim();
    if (!mensaje) return;
    if (chatSocket.readyState !== WebSocket.OPEN) return;
    chatSocket.send(JSON.stringify({ mensaje }));
    input.value = "";
  };
</script>


{% endblock %}